# syncctl

`syncctl` is a tool for packaging all the artifacts for running [Yggdrasil](https://github.com/distributed-technologies/yggdrasil) in a air-gapped environment.

`syncctl` requires:
* Python 3.9
* [Requests](https://pypi.org/project/requests/)
* [GitPython](https://pypi.org/project/GitPython/)

## Manifest file

The manifest file describes which artifacts and how they should be packaged. It consists of 3 sections.

### `yggdrasil_repository`

The `yggdrasil_repository` section describes the yggdrasil repository to package.

```json
"yggdrasil_repository": {
    "commit": "00d6a62598bc7833bde3e067043fe842bbbccbbf",
    "repository": "https://github.com/distributed-technologies/yggdrasil.git"
}
```

### `helm`

The `helm` section describes how the charts should be templated for finding the images.


```json
"helm": {
    "api_versions": [
        "networking.k8s.io/v1/IngressClass"
    ],
    "values": {
        "config.externalProxy": "127.0.0.1:80"
    }
}
```

| Name           | Type             | Description |
| -------------- | ---------------- | ----------- |
| `api_versions` | `list[str]`      | API versions to pass to `helm template` |
| `values`       | `dict[str, str]` | Values to pass to `helm template` |

### `images`

The `images` section describes the images to package. The list is generated by the tool and shouldn't be edited manually.

```json
"images": [
    {
        "digest": "sha256:2e0e725c9282bfb7b08bea7dbbfd8dbce6410d670e3f8addd9b6540d818ad520",
        "image": "argoproj/argocd",
        "registry": "quay.io",
        "tag": "v2.1.2"
    }
]
```

## Usage

`syncctl` needs a `manifest.json` file (see [`manifest.json.sample`](manifest.json.sample) for a example)

```sh
$ ./syncctl
usage: syncctl [-h] [-v] {mirror-yggdrasil,mirror-charts,mirror-images,resolve-images,tar} ...

positional arguments:
  {mirror-yggdrasil,mirror-charts,mirror-images,resolve-images,tar}
    mirror-yggdrasil    mirror the yggdrasil git repository to the local fs
    mirror-charts       mirror the charts to the local fs
    mirror-images       mirror the container images to the local fs
    resolve-images      resolve container images to digest and update the manifest file
    tar                 create a tarball

options:
  -h, --help            show this help message and exit
  -v, --verbose         Causes to print debugging messages about the progress
```
